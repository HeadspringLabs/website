
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Headspring Labs</title>
	<meta name="author" content="Headspring Labs">

	
	<meta name="description" content="Headspring Labs is the new home for content, projects, and experiments from all the talented developers and consultants at Headspring. This space &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Headspring Labs" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Headspring Labs</a></h1>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/open-source">Open Source</a></li>
	<li><a href="/team">The Team</a></li>
	<li><a href="/about-us">About Us</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:headspringlabs.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/HeadspringLabs" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/HeadspringLabs" title="GitHub">GitHub</a>
		
	    
		
		<a class="coderwall" href="https://coderwall.com/team/headspring" title="Coderwall">Coderwall</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:headspringlabs.com">
	</form>
</nav>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/open-source">Open Source</a></li>
	<li><a href="/team">The Team</a></li>
	<li><a href="/about-us">About Us</a></li>
</ul>
</nav>

</header>
	
		
<div id="banner" class="inner">
	<div class="container">
		<ul class="feed"></ul>
	</div>
	<small><a href="http://twitter.com/HeadspringLabs">HeadspringLabs</a> @ <a href="http://twitter.com">Twitter</a></small>
	<div class="loading">Loading...</div>
</div>
<script src="/javascripts/twitter.js"></script>
<script type="text/javascript">
	(function($){
		$('#banner').getTwitterFeed('HeadspringLabs', 5, );
	})(jQuery);
</script>

	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/welcome-to-headspring-labs/">
		
			Welcome to Headspring Labs</a>
	</h2>
	<div class="entry-content">
		<p>Headspring Labs is the new home for content, projects, and experiments from all the talented developers and consultants at <a href="http://www.headspring.com">Headspring</a>. This space was built for developers at Headspring, but we decided to share it with the rest of the software world.</p>


		
		<a href="/blog/welcome-to-headspring-labs/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-07-20T14:28:00-05:00" pubdate data-updated="true">Jul 20<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/news/'>News</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/by-your-command-line/">
		
			By Your Command (Line)</a>
	</h2>
	<div class="entry-content">
		<p>Last week, we saw an example of <a href="http://www.headspring.com/dynamic-test-discovery/">Dynamic Test Discovery</a> in Fixie, in which the test runner can be made to run a different set of tests each time, depending on context. A Fixie convention could make decisions based on how the test run was initiated. This week, I&#8217;ll demonstrate a similar feature which takes advantage of yet more context.  For this example, our convention will get to make decisions based on the command line arguments used to kick off the test run.</p>

		
		<a href="/blog/by-your-command-line/" class="more-link">Read on &rarr;</a>
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-07-12T00:00:00-05:00" pubdate data-updated="true">Jul 12<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/developer-deep-dive/'>Developer Deep Dive</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/dynamic-test-discovery/">
		
			Dynamic Test Discovery</a>
	</h2>
	<div class="entry-content">
		<p>Recently I received feature requests for <a href="http://plioi.github.io/fixie">Fixie</a> that initially proved difficult. I was tempted to engage in a vague refactoring effort until it became more clear how to proceed. Of course, giving in to that temptation would have proven wasteful. I might have achieved some degree of subjective cleanliness while getting no closer to actually solving the problems I faced.</p>
<p>Instead, I moved Fixie&#8217;s design forward by selecting one of the feature requests as a specific goal. I let the feature tell me where the current design was lacking, which suggested a simple improvement. The more often I focus on concrete features, the faster Fixie&#8217;s design will approach what it needs to be. You don&#8217;t stop feature development in order to engage in open-ended refactoring. Rather, refactoring is what we should do <em>throughout</em> feature development.</p>
<p>The first of these initially-tricky features was to imitate <a href="http://www.nunit.org/index.php?p=explicit&r=2.6.2">NUnit&#8217;s [Explicit] attribute</a>. Let&#8217;s say you want to mark one of your tests so that it will only run when it is explicitly selected to run. Under normal runs of your test suite, these &#8220;explicit&#8221; tests should be ignored. When you run one specifically, though, <em>only</em> that test is run.</p>
<p>Supporting explicit tests is a matter of customizing test <em>discovery</em>. All the examples of test discovery I&#8217;ve written about so far have been <em>static</em>: a method is determined to be a test or not based on the method definition alone. Explicit tests, on the other hand, demonstrate the need for <em>dynamic</em> test discovery rules: sometimes an explicit method is a test, sometimes it isn&#8217;t, and the decision has to be made based on the runtime context we&#8217;re executing under.</p>
<h2>A Convention for Explicit Tests</h2>
<blockquote><p>Todayâ€™s code sample works against <a href="http://nuget.org/packages/Fixie/0.0.1.65">Fixie 0.0.1.65</a>. The customization API is in its infancy, and is likely to change in the coming weeks.</p>
</blockquote>
<p>Consider a test class containing an explicit test:</p>
<p><div><script src='https://gist.github.com/5931115.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Out of the box, Fixie has no idea what [Explicit] means. To support it, we have to define the attribute as well as a custom convention to use it:</p>
<p><div><script src='https://gist.github.com/5931118.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>In this example, we&#8217;re identifying explicit tests with an attribute. We could have just as easily used some other rule for determining which tests are explicit. Perhaps we could see whether the method in question lives in a special *.Explicit namespace, or follows some test naming convention. Attributes seem fine here, though, since explicit tests are rare and should stand out as having a special purpose.</p>
<p>When Fixie searches for test methods, it will use the conditions we specify in the convention. In this case, we inspect each method for an [Explicit] attribute <em>and we consider the context in which we&#8217;re running</em>. We are saying that a method in a test class is a test method if a) it is not [Explicit] or b) it is the sole target of execution.</p>
<h2>Driving Design with Features</h2>
<p>When I first attempted to write an example of explicit tests, I didn&#8217;t yet have access to any such runtime context. I couldn&#8217;t phrase the if-statement because that line of code had no information about how the test execution was kicked off. This stumbling block motivated a simple design change: if a convention accepts a RunContext in its constructor, Fixie will pass in that context. Conventions are no longer limited to static decision making.</p>
<p>I&#8217;m glad I didn&#8217;t give in to the temptation to refactor without a specific feature in mind. Only when I picked a feature and seriously thought about what was missing did I realize how simple the solution would be.</p>
<p>The effect is similar to TDD.  TDD doesn&#8217;t magically create your design for you, but selecting the next test to write focuses your attention on something concrete while giving you a definition of success and an opportunity to improve your design by a small amount.  Similarly, tackling features one at a time doesn&#8217;t magically create your design for you, but selecting the next feature focuses your attention on something concrete while giving you a larger-scale definition of success and a larger opportunity to improve your design.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-07-05T00:00:00-05:00" pubdate data-updated="true">Jul 5<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/developer-deep-dive/'>Developer Deep Dive</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/when-writing-c-use-c/">
		
			When Writing C#, Use C#</a>
	</h2>
	<div class="entry-content">
		<p>Recently, Jimmy Bogard described several <a href="http://lostechies.com/jimmybogard/2013/06/18/strategies-for-isolating-the-database-in-tests/">strategies for isolating a database in tests</a>.  Today, we&#8217;ll see how one of these strategies can be implemented.  We&#8217;ll start with a common implementation under NUnit, then we&#8217;ll identify some issues with that implementation, and lastly we&#8217;ll translate it into a Fixie convention to address those issues.</p>
<blockquote><p>Todayâ€™s code samples work against <a href="http://nuget.org/packages/Fixie/0.0.1.63">Fixie 0.0.1.63</a>. The customization API is in its infancy, and is likely to change in the coming weeks.</p></blockquote>
<h2>Transactions Under NUnit</h2>
<p>One of the strategies from Jimmy&#8217;s post involves starting up a transaction before a test and rolling back that transaction at the end of the test.  If we&#8217;re using NUnit, a common technique is to stow this concept away in a test fixture base class like so:</p>
<p><div><script src='https://gist.github.com/5864032.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Our integration tests can inherit this base class, allowing each test to run in isolation.  Each test gets to work against the same state.</p>
<p>This approach has a few problems.</p>
<p>First, we&#8217;ve got a bit of a temporal coupling issue: this works because we trust that SetUp() and TearDown() will be called in a particular order. Ok, so it&#8217;s not an example of temporal coupling gone horribly wrong - NUnit <em>will</em> call them in the right order. Still, it&#8217;s a bit of a code smell in that it motivates us to explicitly call Dispose(), despite the fact that C# already has a keyword (&#8220;using&#8221;) devoted to automating that call safely. NUnit&#8217;s lifecycle attributes are like a mini language built on top of C#, and <strong>we&#8217;re writing this code in NUnit-the-language instead of writing it in C#</strong>.</p>
<p>Second, relying on [SetUp] and [TearDown] in a base class can get a little ugly when the child test class also needs to have a [SetUp] or [TearDown], as we saw in <a href="http://www.headspring.com/dry-test-inheritance/">DRY Test Inheritance</a>.  Should we mark these methods <code>virtual</code> so child classes don&#8217;t have to come up with new names for their own [SetUp]s and [TearDown]s? If child classes override them, they could easily forget to call base.SetUp() and base.TearDown(). Even if they remember to, that&#8217;s more boilerplate than feels necessary.</p>
<p><strong>Yikes. I just wanted to wrap my tests in transactions. Let&#8217;s do that instead.</strong></p>
<h2>Transactions Under Fixie</h2>
<p>As I&#8217;ve demonstrated in recent weeks, Fixie conventions allow you to describe test <em>discovery</em> as well as test<em>execution</em>. In this case, we&#8217;ll stick with the simple style of test discovery that Fixie uses by default, but we&#8217;ll also augment test execution with a transaction:</p>
<p><div><script src='https://gist.github.com/5864039.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>The Fixtures and Cases code resembles what Fixie offers in its DefaultConvention.  Like the DefaultConvention, we also get one instance of the test class for each test being executed.  The relevant bit is the last section:</p>
<p><div><script src='https://gist.github.com/5864050.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Here, we are saying that the normal behavior for each test class instance (&#8220;run the test&#8221;) should be wrapped in a new TransactionScope. In other words, &#8220;within a transaction, proceed with the test execution&#8221;.</p>
<blockquote><p>This part of the API deserves more attention. Better names for each concept could make it more clear what&#8217;s going on with this &#8216;innerBehavior&#8217;. It works, but it&#8217;s still too wordy.</p></blockquote>
<p>I&#8217;ve been focusing lately on supporting this notion of <em>wrapping</em> the built-in behavior with a short code snippet, instead of NUnit&#8217;s separate Before/After approach, because it offers more degrees of freedom: a wrapping action can do extra work before, after, around, or even <em>instead of</em> the built-in behavior. A nice little bonus is that we get to write our C# in C#: the code that cares about transactions is now as small as can be and resembles the way you would use a TransactionScope in the code-under-test.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-06-26T00:00:00-05:00" pubdate data-updated="true">Jun 26<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/developer-deep-dive/'>Developer Deep Dive</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/streamlined-integration-tests/">
		
			Streamlined Integration Tests</a>
	</h2>
	<div class="entry-content">
		<p>Last week, we saw how <a href="http://plioi.github.io/fixie/">Fixie</a> can be used to <a href="http://www.headspring.com/dry-test-inheritance/">simplify NUnit&#8217;s treatment of inheritance</a>.  This week, we&#8217;ll see how to use it to streamline integration tests in systems that leverage IoC containers.</p>
<blockquote><p>Today&#8217;s code samples work against <a href="http://nuget.org/packages/Fixie/0.0.1.62">Fixie 0.0.1.62</a>. The customization API is in its infancy, and is likely to change in the coming weeks.</p></blockquote>
<h2>Setting the Scene</h2>
<p>Assume, for the sake of argument, that you&#8217;ve already weighed the pros and cons of using IoC containers and have decided to use one in an ASP.NET MVC application.  During app startup, the IoC container is configured to provide the real implementations of your dependencies, but at test time you have the option of providing fakes.  You&#8217;ve also configured MVC to defer to the container whenever MVC wishes to instantiate a controller.</p>
<p>VoilÃ !  Now your controllers can declare their dependencies by simply accepting them via constructor parameters:</p>
<p><div><script src='https://gist.github.com/5819891.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>This approach gives you something very powerful: a way to say, &#8220;I need a thing.  I don&#8217;t care where it came from.  I don&#8217;t even care if it&#8217;s real.  Get me one so I can interact with it.&#8221;  To make such a request, you simply accept an argument in the controller constructor.</p>
<h2>Typical Integration Testing</h2>
<p>Now consider the testing of classes which accept such dependencies in their constructors.  In <em>unit</em> tests for such a class, you can pass in a fake implementation or a mock if the dependency is complex, resource intensive, or unreliable in a way that distracts from the behavior you are trying to test.  In <em>integration</em> tests, though, you&#8217;re far more likely to want to pass in the <em>real</em> implementations of the constructor arguments, to demonstrate something closer to the true behavior you&#8217;ll experience in production.</p>
<p>The integration test classes therefore likely call into some helper class or base class method in order to obtain a test-friendly version of the IoC container.  It might be <em>identical</em> to the IoC configuration used at runtime, so that the tests hit real databases and web services, for instance.  More likely, this test-specific IoC configuration would be <em>mostly</em> like the real thing but with a select few fakes still in the mix.  Perhaps you want to test your system&#8217;s interaction with your database and internal web services, while still faking out unreliable third-party systems.</p>
<blockquote><p>Running your integration tests should exercise as much of the real system as is reasonably possible.  However, running your integration tests shouldn&#8217;t trigger a hurricane of unintentional spam tweets to all of your CEO&#8217;s followers.  Better to still use a fake ITwitter, eh?</p></blockquote>
<h2>Leveraging IoC in Tests</h2>
<p><strong>We use IoC containers to streamline the code-under-test, so why do we throw that train of thought out the window when we write the tests themselves?</strong></p>
<p>If I want to, I should be able to declare test classes whose constructors similarly accept <em>their</em> dependencies too.  I shouldn&#8217;t have to explicitly call out to a test helper method to get the integration-test-friendly IoC container, just so I can bypass all the intended brevity and instead explicitly ask the container for instances of things I want to interact with!</p>
<p>Here&#8217;s a sample test class in Fixie that leverages IoC just as much as the familiar controller does:</p>
<p><div><script src='https://gist.github.com/5819905.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>We don&#8217;t have to throw out all the benefits of IoC when writing tests for things that take part in IoC.  There are a few noteworthy details in this example:</p>
<p><strong>Familiar constructor injection</strong> - The test class accepts dependencies via the constructor.  In this case, we inject an ISupportTicketRepository to inspect the effects of our controller.  We also inject the controller under test itself, allowing the IoC container to build it just like it would in the running application.</p>
<p><strong>No test base/helper class</strong> - Just like our controllers, our test classes avoid explicitly interacting with the IoC container.  Instead, they focus on the behavior being tested.</p>
<p><strong>Fakes when you wanted them</strong> - The intent of these tests involves hitting a real web service backed by a real database in our test environment, while avoiding real-world tweeting.</p>
<h2>Take Control of Test Fixture Construction</h2>
<p>Clearly, we&#8217;ve missed a step.  How could a test framework possibly know which container to use, or how to configure it for real web services but fake tweeting?  The answer lies in our Fixie convention (assume that IoCContainer is some newfangled third-party IoC container, similar to StructureMap):</p>
<p><div><script src='https://gist.github.com/5819909.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>With this convention class in place, all of our integration tests can accept arguments through their constructors, and they will do so with a container that contains mostly-real things, plus a few fakes.  With this approach, we get to &#8220;wear the IoC hat&#8221; in our test code as well as our code-under-test.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-06-20T00:00:00-05:00" pubdate data-updated="true">Jun 20<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/developer-deep-dive/'>Developer Deep Dive</a>


</div>
	
</div>
</article>

<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2013

    Headspring Labs

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>