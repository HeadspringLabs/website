
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Seamless Generic Type Casting - Headspring Labs</title>
  <meta name="author" content="Headspring Labs">

  
  <meta name="description" content="In Array Covariance in C#, we saw that a List&lt;Apple&gt; cannot be assigned to a variable declared as List&lt;Object&gt;, even though all Apples &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://headspringlabs.com/blog/seamless-generic-type-casting">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Headspring Labs" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Headspring Labs</a></h1>
  
    <h2>Experiments by Headspringers!</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:headspringlabs.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Seamless Generic Type Casting</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-28T00:00:00-05:00" pubdate data-updated="true">Oct 28<span>th</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>In <a href="http://www.headspring.com/2011/10/array-covariance-in-c">Array Covariance in C#</a>, we saw that a <code>List&lt;Apple&gt;</code> cannot be assigned to a variable declared as <code>List&lt;Object&gt;</code>, even though all <code>Apple</code>s are <code>Object</code>s. If we were allowed to do that, we could get runtime type exceptions as we work with the list contents.</p>
<p>The compiler has to prevent us from these assignments because <code>List&lt;T&gt;</code>&#8217;s public interface includes some subtle constraints: <code>List&lt;Apple&gt;</code> is actually a <em>more constrained</em> type than <code>List&lt;Object&gt;</code>. You can put anything into a <code>List&lt;Object&gt;</code> and get it back out again. You can&#8217;t put just anything into a <code>List&lt;Apple&gt;</code>; what would you expect to happen when you tried to read it back out? <!--more-->Therefore, <code>List&lt;Apple&gt;</code> is more constrained than <code>List&lt;Object&gt;</code> and we can&#8217;t treat <code>List&lt;Apple&gt;</code> as a subtype of <code>List&lt;Object&gt;</code>.</p>
<p>Still, it&#8217;s tempting to ask, is there some other generic type <code>Foo&lt;T&gt;</code> where <code>Foo&lt;Apple&gt;</code> <em>can</em> be treated as a <code>Foo&lt;Object&gt;</code>? <strong>It turns out the answer is yes!</strong></p>
<p>Let&#8217;s say your application is sending messages to another process over a message bus, and that you&#8217;ve implemented a helper method that sends a whole collection of messages instead of just one:</p>
<p><div><script src='https://gist.github.com/1321180.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Unfortunately, this won&#8217;t even compile. We&#8217;re trying to send a list of <code>RemoveOrderLineItem</code> messages, but the <code>SendAll</code> method accepts a <code>List&lt;IMessage&gt;</code>. Fortunately, this starts to compile if we change the definition of <code>SendAll</code> to receive an <code>IEnumerable&lt;IMessage&gt;</code> instead of a <code>List&lt;T&gt;</code>:</p>
<p><div><script src='https://gist.github.com/1321168.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>What&#8217;s so <em>special</em> about <code>IEnumerable&lt;IMessage&gt;</code> that lets us seamlessly cast from a <code>List&lt;RemoveOrderLineItem&gt;</code>? Remember, the reason that the compile originally failed had to do with the fact that the object we were passing to <code>SendAll</code> had more constraints than the type declared on the receiving end. With <code>IEnumerable&lt;IMessage&gt;</code>, it&#8217;s a different story. Now, the only thing that <code>SendAll</code> can do with our collection is get values out of it, and we know all such values will be individually compatable with <code>IMessage</code>.</p>
<p>We&#8217;re able to do this because, as of .NET 4, <code>IEnumerable&lt;T&gt;</code> has an updated definition:</p>
<p><div><script src='https://gist.github.com/1321170.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>The <code>out</code> keyword was added to the generic type parameter <code>T</code>. Using this keyword is a promise. <strong>&#8220;I promise that for all the members in this interface, <code>T</code> will only appear in the return types, never appearing in any inputs.&#8221;</strong> When we use the <code>out</code> keyword, we&#8217;re saying that T is &#8220;covariant&#8221;.</p>
<p>The <code>in</code> keyword makes a similar promise: the type parameter <code>T</code> could appear in the types of input arguments, but never in the return types. When we use the <code>in</code> keyword, we&#8217;re saying that <code>T</code> is &#8220;contravariant&#8221;.</p>
<p>In addition to sanity checking your promise, the compiler is now free to treat any <code>IEnumerable&lt;RemoveOrderLineItem&gt;</code> as a <code>IEnumerable&lt;IMessage&gt;</code>, without having to cast each individual item first. <code>IEnumerable&lt;RemoveOrderLineItem&gt;</code> is truly a subtype of <code>IEnumerable&lt;IMessage&gt;</code>.</p>
<p>Introducing these two keywords to the language was a nonbreaking change, with the main effect being that people encountered fewer compiler errors, usually without knowing it. When you design your own libraries, consider whether your interfaces deserve to take part in this style of casting. Beware, though, that <em>removing</em> the keywords later on can be a breaking change from the point of view of your library&#8217;s consumer!</p>
<p>In my next post, we&#8217;ll see how these keywords can be used to glue together delegates.</p>
<p><a href="http://www.headspring.com/feed" target="_blank">Subscribe to our blog feed</a> for the freshest content.</p>
</div>


  <footer>
    <p class="meta">
      
  



      








  


<time datetime="2011-10-28T00:00:00-05:00" pubdate data-updated="true">Oct 28<span>th</span>, 2011</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://headspringlabs.com/blog/seamless-generic-type-casting/" data-via="HeadspringLabs" data-counturl="http://headspringlabs.com/blog/seamless-generic-type-casting/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/unit-testing-best-practices-know-your-tests-lifecycle-part-3/" title="Previous Post: Unit Testing Best Practices: Know Your Test’s Lifecycle, Part 3">&laquo; Unit Testing Best Practices: Know Your Test’s Lifecycle, Part 3</a>
      
      
        <a class="basic-alignment right" href="/blog/reasons-why-people-break-upwith-their-company/" title="Next Post: Reasons Why People Break Up…With Their Company">Reasons Why People Break Up…With Their Company &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/dry-test-inheritance/">DRY Test Inheritance</a>
      </li>
    
      <li class="post">
        <a href="/blog/the-sincerest-form-of-flattery/">The Sincerest Form of Flattery</a>
      </li>
    
      <li class="post">
        <a href="/blog/fixies-life-bicycle/">Fixie's Life Bicycle</a>
      </li>
    
      <li class="post">
        <a href="/blog/test-discovery/">Test Discovery</a>
      </li>
    
      <li class="post">
        <a href="/blog/enabling-change/">Enabling Change</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/HeadspringLabs">@HeadspringLabs</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'HeadspringLabs',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Headspring Labs -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
