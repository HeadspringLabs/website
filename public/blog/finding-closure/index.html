
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Finding Closure - Headspring Labs</title>
	<meta name="author" content="Headspring Labs">

	
	<meta name="description" content="When writing software, we constantly create abstractions. The goal each time is to present a simple interface in front of something more complex, &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Headspring Labs" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><a href="/"><h1>Headspring Labs</h1></a>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/team">The Team</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/open-source">Open Source</a></li>
	<li><a href="/about-us">About Us</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:headspringlabs.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/HeadspringLabs" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/HeadspringLabs" title="GitHub">GitHub</a>
		
	    
		
		<a class="coderwall" href="https://coderwall.com/team/headspring" title="Coderwall">Coderwall</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:headspringlabs.com">
	</form>
</nav>
<nav id="main-nav"><ul class="main">
	<li><a href="/team">The Team</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/open-source">Open Source</a></li>
	<li><a href="/about-us">About Us</a></li>
</ul>
</nav>

</header>
	
		
<div id="banner" class="inner">
	<div class="container">
		<ul class="feed"></ul>
	</div>
	<small><a href="http://twitter.com/HeadspringLabs">HeadspringLabs</a> @ <a href="http://twitter.com">Twitter</a></small>
	<div class="loading">Loading...</div>
</div>
<script src="/javascripts/twitter.js"></script>
<script type="text/javascript">
	(function($){
		$('#banner').getTwitterFeed('HeadspringLabs', 5, );
	})(jQuery);
</script>

	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Finding Closure</h2>
	<div class="entry-content"><p>When writing software, we constantly create abstractions.  The goal each time is to present a simple interface in front of something more complex, hiding the gory details from us so we can focus on other things.  The problem is, <a href="http://en.wikipedia.org/wiki/Leaky_abstraction">abstractions leak</a>.  Even when you go to great effort to create a really exellent abstraction, some unfortunate implementation detail manages to rear its ugly head.  This even happens with things so fundamental that we take them for granted.  Take the &#8216;foreach&#8217; keyword in C#:</p>
<p><div><script src='https://gist.github.com/1990055.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Where we would expect the output to be:<br />
    Hello, Larry!<br />
    Hello, Moe!<br />
    Hello, Curly!</p>
<p>Instead, we see:<br />
    Hello, Curly!<br />
    Hello, Curly!<br />
    Hello, Curly!</p>
<p>Fortunately, ReSharper points out that something fishy is going on with the reference to <code>name</code> that appears in the loop body: <strong>&#8220;Access to modified closure.&#8221;</strong>  If you follow the ReSharper suggested fix, you get this:</p>
<p><div><script src='https://gist.github.com/1990084.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Oddly, introducing this local variable <em>does</em> fix the output, but why?  To find out, let&#8217;s first rewrite the original version using a transformation from a <code>foreach</code> loop to a <code>while</code> loop, since that&#8217;s the first thing the compiler does for us.  It still erroneously prints &#8220;Hello, Curly!&#8221; three times:</p>
<p><div><script src='https://gist.github.com/1990116.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>ReSharper still highlights the use of <code>name</code> within the loop body, and still says it is an &#8220;Access to modified closure.&#8221;  Before we can try to fix the problem, we&#8217;re going to have to make sense of that warning.</p>
<h2>What&#8217;s a Closure?</h2>
<p>The word &#8220;closure&#8221; comes up a lot when talking about any language that has anonymous inline functions.  In C#, that means anonymous delegates and their shorthand lambda expressions introduced with <code>=&gt;</code>.  You have comparable anonymous functions in Javascript, Ruby, Python, etc.  Whenever you have an anonymous function whose body refers to identifiers in the surrounding scope, the function earns the right to call itself a closure.</p>
<p>Lambdas are really shorthand for a class with one method as well as the instantiation of that class.  In our example above, the lambdas are living beyond the execution of the loop, and that means they need to live beyond the normal scope of the loop variable, <code>name</code>.  In order to work, they&#8217;ll need to hold onto something about that variable.  In fact, they hold onto the <em>environment</em> that was in effect at the moment the lambda was reached.  By environment, I mean <em>all</em> of the local variables they might be referring to.  It is as if we wrote the following, which also prints &#8220;Hello, Curly!&#8221; three times:</p>
<p><div><script src='https://gist.github.com/1990154.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>AHA! See how we have only <em>one</em> instance of Environment shared by all the <code>Greeter</code>s, and each iteration of the loop messes with the <code>name</code> field <em>inside</em> that shared Environment?  No wonder our final loop prints out the same thing each time: all the items in <code>delayedGreetings</code> refer to the same Environment, which contains only one name, which equals whatever we set it to <em>last</em>.</p>
<p>They call these lambdas &#8220;closures&#8221; because the secret object behind the scenes is grasping-at / enveloping / <em>closing-on</em> the local environment.  As we see in the last example, even after the environment is closed on, we can still affect that environment.  We say that the lambda is closing on the <em>variables themselves</em> rather than simply holding a reference to their <em>values</em>.</p>
<p><strong>Even foreach leaks.</strong></p>
<h2>Fixing foreach</h2>
<p>So we&#8217;ve got this fancy compiler that can take a combination of <code>foreach</code> and lambda expressions, rewriting them into some equivalent-yet-verbose code, which in turn is easier to compile.  It&#8217;s a big abstraction that usually works so well we don&#8217;t stop to think it&#8217;s even <em>happening</em>.  How could we fix it?</p>
<p>It seems the whole problem comes down to the fact that with one shared environment, each iteration messes with a shared mutable object.  We get one environment per scope, though, and the <code>while</code> loop body introduces a new, more-local scope of its own!  We could take advantage of that by declaring the loop-iteration variable <code>name</code> <em>within</em> the <code>while</code> instead of <em>before</em> it.  This way, each iteration will get its own Environment with its own <code>name</code>.  Nothing shared, nothing mutated, leaving us with the three distinct greetings we wanted.  In other words, we wish that <code>foreach</code> gets translated into a <code>while</code> loop like so:</p>
<p><div><script src='https://gist.github.com/1990196.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>ReSharper&#8217;s suggestions basically accomplish the same thing.  By introducing a seemingly-redundant copy within the smaller scope, the environment used by the lambdas is different in each iteration.</p>
<p>Usually when something as fundamental as a looping keyword has a problem like this, the language designers don&#8217;t really have the option of correcting it.  It&#8217;s technically a breaking change to make all <code>foreach</code> loops translate to the better version of the <code>while</code> seen in the last example.  <strong>However, they are going to be <a href="http://blogs.msdn.com/b/ericlippert/archive/2009/11/12/closing-over-the-loop-variable-considered-harmful.aspx">fixing foreach in C#5</a>.</strong> It&#8217;s a breaking change, but one that will <em>fix</em> more mistakes than it <em>creates</em>!</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-03-09T00:00:00-06:00" pubdate data-updated="true">Mar 9<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/developer-deep-dive/'>Developer Deep Dive</a>, <a class='category' href='/blog/categories/developing-with-c-number/'>developing with C#</a>


</div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
	
</div>


</div>
	<footer id="footer" class="inner"><div class="related-links">
	<h3>Other Headspring Sites</h3>
	<ul>
		<li><a href="http://www.headspring.com">Headspring</a></li>
		<li><a href="http://www.headspringmobile.com">Headspring Mobile</a></li>
	</ul>
</div>

<div class="related-links">
	<h3>Communities/Groups</h3>
	<ul>
		<li><a href="http://www.adnug.org">ADNUG</a></li>
		<li><a href="http://polyglotprogrammers.org">Polyglot ATX</a></li>
	</ul>
</div>

<div class="related-links">
	<h3>Open Source</h3>
	<ul>
		<li><a href="http://www.adnug.org">AutoMapper</a></li>
		<li><a href="http://polyglotprogrammers.org">Formo</a></li>
		<li><a href="http://polyglotprogrammers.org">Parsely</a></li>
		<li><a href="http://polyglotprogrammers.org">NAAK</a></li>
	</ul>
</div>

<div class="related-links">
	<h3>Events</h3>
	<ul>
		<li><a href="http://www.adnug.org">CTX Givecamp</a></li>
		<li><a href="http://polyglotprogrammers.org">Houston TechFest</a></li>
		<li><a href="http://polyglotprogrammers.org">Austin Code Camp</a></li>
	</ul>
</div>

<hr />

Copyright &copy; 2013

    Headspring Labs

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>