
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>When Writing C#, Use C# - Headspring Labs</title>
	<meta name="author" content="Headspring Labs">

	
	<meta name="description" content="Recently, Jimmy Bogard described several strategies for isolating a database in tests. Today, we&#8217;ll see how one of these strategies can be &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Headspring Labs" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.1.6/d3.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><a href="/"><h1>Headspring Labs</h1></a>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/team">The Team</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/open-source">Open Source</a></li>
	<li><a href="/about-us">About Us</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:headspringlabs.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/HeadspringLabs" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/HeadspringLabs" title="GitHub">GitHub</a>
		
	    
		
		<a class="coderwall" href="https://coderwall.com/team/headspring" title="Coderwall">Coderwall</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:headspringlabs.com">
	</form>
</nav>
<nav id="main-nav"><ul class="main">
	<li><a href="/team">The Team</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/open-source">Open Source</a></li>
	<li><a href="/about-us">About Us</a></li>
</ul>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">When Writing C#, Use C#</h2>
	<div class="entry-content"><p>Recently, Jimmy Bogard described several <a href="http://lostechies.com/jimmybogard/2013/06/18/strategies-for-isolating-the-database-in-tests/">strategies for isolating a database in tests</a>.  Today, we&#8217;ll see how one of these strategies can be implemented.  We&#8217;ll start with a common implementation under NUnit, then we&#8217;ll identify some issues with that implementation, and lastly we&#8217;ll translate it into a Fixie convention to address those issues.</p>
<blockquote><p>Todayâ€™s code samples work against <a href="http://nuget.org/packages/Fixie/0.0.1.63">Fixie 0.0.1.63</a>. The customization API is in its infancy, and is likely to change in the coming weeks.</p></blockquote>
<h2>Transactions Under NUnit</h2>
<p>One of the strategies from Jimmy&#8217;s post involves starting up a transaction before a test and rolling back that transaction at the end of the test.  If we&#8217;re using NUnit, a common technique is to stow this concept away in a test fixture base class like so:</p>
<p><div><script src='https://gist.github.com/5864032.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Our integration tests can inherit this base class, allowing each test to run in isolation.  Each test gets to work against the same state.</p>
<p>This approach has a few problems.</p>
<p>First, we&#8217;ve got a bit of a temporal coupling issue: this works because we trust that SetUp() and TearDown() will be called in a particular order. Ok, so it&#8217;s not an example of temporal coupling gone horribly wrong - NUnit <em>will</em> call them in the right order. Still, it&#8217;s a bit of a code smell in that it motivates us to explicitly call Dispose(), despite the fact that C# already has a keyword (&#8220;using&#8221;) devoted to automating that call safely. NUnit&#8217;s lifecycle attributes are like a mini language built on top of C#, and <strong>we&#8217;re writing this code in NUnit-the-language instead of writing it in C#</strong>.</p>
<p>Second, relying on [SetUp] and [TearDown] in a base class can get a little ugly when the child test class also needs to have a [SetUp] or [TearDown], as we saw in <a href="http://www.headspring.com/dry-test-inheritance/">DRY Test Inheritance</a>.  Should we mark these methods <code>virtual</code> so child classes don&#8217;t have to come up with new names for their own [SetUp]s and [TearDown]s? If child classes override them, they could easily forget to call base.SetUp() and base.TearDown(). Even if they remember to, that&#8217;s more boilerplate than feels necessary.</p>
<p><strong>Yikes. I just wanted to wrap my tests in transactions. Let&#8217;s do that instead.</strong></p>
<h2>Transactions Under Fixie</h2>
<p>As I&#8217;ve demonstrated in recent weeks, Fixie conventions allow you to describe test <em>discovery</em> as well as test<em>execution</em>. In this case, we&#8217;ll stick with the simple style of test discovery that Fixie uses by default, but we&#8217;ll also augment test execution with a transaction:</p>
<p><div><script src='https://gist.github.com/5864039.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>The Fixtures and Cases code resembles what Fixie offers in its DefaultConvention.  Like the DefaultConvention, we also get one instance of the test class for each test being executed.  The relevant bit is the last section:</p>
<p><div><script src='https://gist.github.com/5864050.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Here, we are saying that the normal behavior for each test class instance (&#8220;run the test&#8221;) should be wrapped in a new TransactionScope. In other words, &#8220;within a transaction, proceed with the test execution&#8221;.</p>
<blockquote><p>This part of the API deserves more attention. Better names for each concept could make it more clear what&#8217;s going on with this &#8216;innerBehavior&#8217;. It works, but it&#8217;s still too wordy.</p></blockquote>
<p>I&#8217;ve been focusing lately on supporting this notion of <em>wrapping</em> the built-in behavior with a short code snippet, instead of NUnit&#8217;s separate Before/After approach, because it offers more degrees of freedom: a wrapping action can do extra work before, after, around, or even <em>instead of</em> the built-in behavior. A nice little bonus is that we get to write our C# in C#: the code that cares about transactions is now as small as can be and resembles the way you would use a TransactionScope in the code-under-test.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-06-26T00:00:00-05:00" pubdate data-updated="true">Jun 26<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/developer-deep-dive/'>Developer Deep Dive</a>


</div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
	
</div>


</div>
	<footer id="footer" class="inner"><div class="related-links">
	<h3>Other Headspring Sites</h3>
	<ul>
		
		
			<li><a href="http://www.headspring.com">Headspring</a></li>
		
		
			<li><a href="http://www.headspringmobile.com">Headspring Mobile</a></li>
		
	</ul>
</div>

<div class="related-links">
	<h3>Communities/Groups</h3>
	<ul>
		
		
			<li><a href="http://www.adnug.org">ADNUG</a></li>
		
		
			<li><a href="http://polyglotprogrammers.org/">Polyglot Programmers</a></li>
		
	</ul>
</div>

<div class="related-links">
	<h3>Open Source</h3>
	<ul>
		
		
			
				
				<li><a href="http://automapper.org">AutoMapper</a></li>
				
			
		
		
			
				
				<li><a href="https://github.com/HeadspringLabs/Enumeration">Enumeration</a></li>
				
			
		
		
			
				
				<li><a href="http://chrismissal.com/Formo">Formo</a></li>
				
			
		
		
			
				
				<li><a href="http://plioi.github.io/fixie">Fixie</a></li>
				
			
		
		
			
		
		
			
		
		
			
		
	</ul>
</div>

<div class="related-links">
	<h3>Events</h3>
	<ul>
		
		
			<li><a href="http://ctxgivecamp.org/">Central Texas GiveCamp</a></li>
		
		
			<li><a href="http://www.houstontechfest.org/">Houston Tech Fest</a></li>
		
		
			<li><a href="http://codecamp13.adnug.org/">Austin Code Camp</a></li>
		
	</ul>
</div>

<hr />

Copyright &copy; 2013

    Headspring Labs

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>