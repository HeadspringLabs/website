
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Headspring Labs</title>
	<meta name="author" content="Headspring Labs">

	
	<meta name="description" content="In A Game of Throws, we saw a frequently-blogged-about gotcha regarding the yield keyword and exception handling. This week, we&#8217;ll see how &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Headspring Labs" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Headspring Labs</a></h1>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/open-source">Open Source</a></li>
	<li><a href="/team">The Team</a></li>
	<li><a href="/about-us">About Us</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:headspringlabs.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/HeadspringLabs" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/HeadspringLabs" title="GitHub">GitHub</a>
		
	    
		
		<a class="coderwall" href="https://coderwall.com/team/headspring" title="Coderwall">Coderwall</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:headspringlabs.com">
	</form>
</nav>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/open-source">Open Source</a></li>
	<li><a href="/team">The Team</a></li>
	<li><a href="/about-us">About Us</a></li>
</ul>
</nav>

</header>
	
		
<div id="banner" class="inner">
	<div class="container">
		<ul class="feed"></ul>
	</div>
	<small><a href="http://twitter.com/HeadspringLabs">HeadspringLabs</a> @ <a href="http://twitter.com">Twitter</a></small>
	<div class="loading">Loading...</div>
</div>
<script src="/javascripts/twitter.js"></script>
<script type="text/javascript">
	(function($){
		$('#banner').getTwitterFeed('HeadspringLabs', 5, );
	})(jQuery);
</script>

	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/the-defensive-toarray/">
		
			The Defensive ToArray</a>
	</h2>
	<div class="entry-content">
		<p>In <a href="http://www.headspring.com/patrick/a-game-of-throws/">A Game of Throws</a>, we saw a frequently-blogged-about gotcha regarding the <code>yield</code> keyword and exception handling.  This week, we&#8217;ll see how there is more than one motivation for using the <code>yield</code> keyword, and when you opt into it for one you get the other whether you like it or not.  This leads to a code smell: littering our code with &#8216;defensive&#8217; calls to ToArray(). </p>
<h2>Generalizing the Exception Gotcha</h2>
<p>The exception handling case from last week is a specific example of a larger potential gotcha: with lazy evaluation, some work <em>happens</em> at a different time than the caller might expect.  It allows exceptions to get &#8220;smuggled&#8221; through try/catch blocks, but exceptions are just one way you might be surprised by the change in the order of events: if your <code>yield</code>ing method has any kind of side effect, the caller is likely to experience the odd order of evaluation.</p>
<p>That can be good.  That can be bad.  It&#8217;s a sharp tool.</p>
<h2>Complecting Brevity with Laziness</h2>
<p>This week, I&#8217;d like to cover another problem with lazy evaluation.  Maybe it&#8217;s really just a corollary of the order-of-events gotcha, but I want to call it out specially because it has to do less with the nuts-and-bolts of code execution and more to do with the emergent human behavior that results <em>from</em> people&#8217;s understanding of the problem: the Defensive ToArray.</p>
<p>There are two reasons to use the <code>yield</code> keyword:  laziness and brevity.</p>
<p><strong>Laziness is the advertised feature:</strong> you can produce a collection&#8217;s items on demand, as the caller tries to loop through them.  Laziness enables awesome things like assembling LINQ queries over multiple statements before finally starting to iterate through the overall result.</p>
<p><strong>Brevity is the tempting, likely-unintended feature</strong>: a really monotonous pattern can be shortened using the <code>yield</code> keyword:</p>
<p><div><script src='https://gist.github.com/3823991.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>It&#8217;s tempting to look at that explicit list create/Add/return pattern and say, &#8220;I can shorten that with <code>yield</code>!&#8221;</p>
<p><div><script src='https://gist.github.com/3823995.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Or even shorter:</p>
<p><div><script src='https://gist.github.com/3823997.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>…but even that uses <code>yield</code>&#8217;s semantics under the surface.</p>
<p>The problem is that we opted into <code>yield</code> (or equivalently Select) for the brevity, but we <em>got</em> laziness along with it.  Now we all have to be wary every time we call a method that returns an IEnumerable.  My inner monologue starts to sound like the following:</p>
<blockquote><p>Is this call lazy?  Would it be unsafe to pass the result around before defensively <em>realizing</em> it with a call to .ToArray()?  If I <em>do</em> that .ToArray() call defensively, am I stomping all over the original developer&#8217;s intentions?</p></blockquote>
<p>Now I have to start looking at the implementation of a method I&#8217;m calling in order to know whether or not its result is to be immediately distrusted.  <em>Do I have to finish writing that other developer&#8217;s method with a .ToArray because they were being particularly… er… lazy?</em></p>
<p>I&#8217;m starting to think that most calls to .ToArray() are a code smell, or rather an in-your-face workaround for a code smell.  Even when it&#8217;s doing the right thing, it&#8217;s too wordy and puts the onus on the caller rather than the guilty callee.  I don&#8217;t want to have to fix the result of another method, and I don&#8217;t want to have to look at a thousand such fixes littered throughout a project.</p>
<h2>Let&#8217;s Start Communicating Intent</h2>
<p>In response to all this, I have two items on my wishlist.  One is a wish for an addition to C#, and the other we can use in our projects today.</p>
<p>First, I wish that if a <code>yield</code>ing method were declared to return an array or anything that has a constructor accepting an IEnumerable&lt;T&gt;, that the items be immediately iterated through and packaged as that type.  This way, you could get the brevity while communicating that you are not interested in the side effects of laziness:</p>
<p><div><script src='https://gist.github.com/3824003.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Second, something we can do today: I wish that we could start standardizing on a naming convention for extension methods similar to Select that are not lazy: Map is a common term in other platforms.  Select would still lazily produce one IEnumerable from another, but Map methods would always do a defensive .ToArray for you.  You&#8217;d have to write a Map overload for every collection type you care about, but there&#8217;s really just a handful of collection types you&#8217;ll care about in practice.  For instance:</p>
<p><div><script src='https://gist.github.com/3824012.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Without these Map methods, every time you see a Select you have to wonder what the original developer&#8217;s intention was.  <strong>If instead Map was the first method you reached for, then you would only reach for Select when you actually wanted lazy evaluation.</strong>    Reading through someone else&#8217;s code, Select calls would communicate deliberate laziness with potential side effect gotchas, and Map calls would communicate deliberate brevity with no such gotchas.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-10-02T00:00:00-05:00" pubdate data-updated="true">Oct 2<span>nd</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/developer-deep-dive/'>Developer Deep Dive</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/a-game-of-throws/">
		
			A Game of Throws</a>
	</h2>
	<div class="entry-content">
		<p>In <a href="http://www.headspring.com/blog/developer-deep-dive/infinite-laziness/">Infinite Laziness</a>, we saw how the <code>yield</code> keyword lets us work with <em>lazy evaluation</em>, in which work is deferred and performed on demand once something else actually needs to consume the result.  Lazy evaluation with <code>yield</code> isn&#8217;t free, though; it has some unfortunate consequences.</p>
<p>This week, we&#8217;ll see how lazy evaluation affects exception handling.  Next week, we&#8217;ll see how <code>yield</code> complects brevity with laziness, resulting in some undesirable patterns.</p>
<p>Let&#8217;s say you&#8217;re lazily producing a series of objects, but the creation of each object has a real potential to throw an exception.  The developer calling the lazy method knows that the operation could fail, and attempts to protect the rest of the system:</p>
<p><div><script src='https://gist.github.com/3792131.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Despite wrapping the dangerous method call with a <code>try/catch</code> block, callers of SafelyBuildGrenades are in for a surprise.  <strong>The call to BuildGrenades will never throw an ExplosionException, while callers of SafelyBuildGrenades might set off a grenade just by looking at them!</strong></p>
<p>When you call a <code>yield</code>ing method, <strong>no work is performed and the call returns immediately</strong>.  It returns an object that <em>knows how</em> to produce the list of items on demand.  Those items won&#8217;t be produced until someone starts looping through them.  In our example above, this quickly-made object is likewise immediately returned by SafelyBuildGrenades.  The <em>consumer</em> of the result of SafelyBuildGrenades is then free to start looping through it, at which point the code in BuildGrenades will start to execute.  Since an ExplosionException could only be thrown way up in that consumer&#8217;s loop, the consumer&#8217;s loop is where the exception will start moving up the call stack.</p>
<blockquote><p><code>yield</code> is an exception smuggler.  <code>yield</code> hides your dangerous code in a harmless-looking package in order to sneak it past unsuspecting <code>try/catch</code> blocks.  The harmful contents can then be unpacked by the recipient.</p></blockquote>
<p>When using lazy evaluation, which includes the now-ubiquitous IEnumerable extension methods (Select, Where, Take, Skip&#8230;), take care.  Work won&#8217;t be performed until you begin to iterate through the results, so your exception handling will need to take place higher up the call stack.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-09-27T00:00:00-05:00" pubdate data-updated="true">Sep 27<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/developer-deep-dive/'>Developer Deep Dive</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/mvc-boot-camp-updated-for-asp-net-mvc-4/">
		
			MVC Boot Camp Updated for ASP.NET MVC 4</a>
	</h2>
	<div class="entry-content">
		<p>With the release of ASP.NET MVC 4, we’ve updated <a title="MVC4 Boot Camp Curriculum" href="http://www.headspring.com/headspring/mvc-boot-camp/" target="_blank">our boot camp curriculum</a> to include the latest enhancements and features - the biggest of which is the inclusion of ASP.NET Web API. We’ll look at where Web API fits with modern web applications, and where we’ve seen Web API fit best.</p>
<p>ASP.NET MVC 4 also includes a number of mobile enhancements, AJAX improvements, bundling and minification, all of which will be covered in the course.</p>
<p>Hope to see you there!</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-09-25T00:00:00-05:00" pubdate data-updated="true">Sep 25<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/developer-deep-dive/'>Developer Deep Dive</a>, <a class='category' href='/blog/categories/small-talk-and-big-news/'>Small Talk &amp; Big News</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/bugs-of-omission/">
		
			Bugs of Omission</a>
	</h2>
	<div class="entry-content">
		<p>When your software includes faulty logic or conflicting requirements, you&#8217;re very likely to run into unexpected behavior.  These bugs are relatively easy to trigger and diagnose.</p>
<p>A bug of omission, on the other hand, in which you <em>should</em> have included code to cover an edge case, might sit around lurking for quite a while.  When such a bug finally does surface, the behavior may be so counter to your expectations  that you&#8217;ll wonder if maybe, just maybe, a rogue pixie or trickster demigod has cursed your machine.</p>
<p>&#8220;This has been working <em>forever</em> and nobody has changed it!&#8221;  It can seem like things as fundamental as your language&#8217;s own operators can no longer be taken for granted.  Of course, the bug later turns out to be the fault of mere mortals; a particularly rare set of circumstances reveals the gap that was always there.</p>
<p>Case in point: in <a href="http://www.headspring.com/blog/developer-deep-dive/building-rich-enums/">Building Rich Enums</a> we saw the Headspring <a href="https://github.com/Headspringlabs/Enumeration">Enumeration</a> class as a rich alternative to the <code>enum</code> keyword.  This base class makes it easy to create a finite set of named instances of your class.  This week, <em>all of a sudden and without overt provocation</em>, equality comparisons between Enumerations stopped working for us on one project.</p>
<h2>This has been working <em>forever</em>&#8230;</h2>
<p>Until this week, equality comparisons have worked perfectly fine for our Enumerations.  Consider a typical <code>Enumeration</code>:</p>
<p><div><script src='https://gist.github.com/3759210.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>The constructor is private, so you will only be working with the three trusted instances.  If you store these to a database as their underlying integers, you can read them back out with the <code>FromInt32(int)</code> method to get a hold of the corresponding instance.  We even overrode the <code>Equals(object)</code> method just in case you ever passed these around as <code>object</code> instead of the concrete type and still needed to compare them.</p>
<p>The default behavior of the <code>==</code> operator has been enough to date, because reference equality has been a safe assumption: any instance you ever get your hands on will come from one of the three explicit <code>Color</code> constructor calls in the class definition… <strong>but that&#8217;s a lie</strong> or, if we&#8217;re being generous, an untruth of omission.</p>
<h2>…<em>except</em> for this new set of circumstances.</h2>
<p>This week, we started comparing instances of an <code>Enumeration</code> like <code>Color</code> and got unexpected results.  Instances that appeared to be the same were coming back as &#8216;not equal&#8217;.  Stepping through with the debugger, we saw that the instances on the left and right of the <code>==</code> operator contained the same int Value, and the implementation of <code>Equals</code> was written to compare exactly those ints.  Where did we go wrong?</p>
<p>For the first time, we were making comparisons between instances after some instances were serialized-to-JSON and subsequently deserialized-from-JSON.  Deserializing an Enumeration from a string of JSON effectively bypasses all of C#&#8217;s &#8220;protective&#8221; measures like <code>private</code> constructors.  We were producing multiple distinct instances which happened to contain the same int Value, and our reliance on reference equality was no longer enough.</p>
<p>Fortunately, <a href="https://github.com/HeadspringLabs/Enumeration/commit/66afd7471f6588ce52653fa361c445815dc035fa">the fix was simple.</a>  We had omitted overloading the <code>==</code> operator to favor value equality over reference equality.  Now, whether your equal instances are literally the same object or not, you get the equality semantics you&#8217;d expect.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-09-21T00:00:00-05:00" pubdate data-updated="true">Sep 21<span>st</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/developer-deep-dive/'>Developer Deep Dive</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/low-ceremony-xunit/">
		
			Low-Ceremony xUnit</a>
	</h2>
	<div class="entry-content">
		<p>&#8220;High Ceremony&#8221; software includes excessive detail which distracts from the essential thing the coder is trying to convey.  In C# for instance, you could argue that having to place <em>all</em> methods inside classes is needless ceremony.  Your Main() method shouldn&#8217;t need that extra boilerplate, but we just Have To Do It That Way.  We have to perform that ceremony.  Developers who favor dynamic languages would find type declarations to be High Ceremony as well, and even C#ers admit this whenever they use the <code>var</code> or <code>dynamic</code> keywords.</p>
<p>High ceremony isn&#8217;t limited to language details, though.  We can be guilty of introducing it, ourselves.</p>
<h2>Framework Ceremony</h2>
<p>Frameworks often impose ceremony of their own.  ASP.NET MVC, NUnit, and xUnit all require you to litter your code with <code>[Attribte]</code>s in order to give instructions to the framework.  The framework reflects over your code, discovers these attributes, and takes action.  Usually this is all done so that the framework will know when, during its own lifecycle, your code should be invoked.  Take a look at NUnit test fixtures:</p>
<p><div><script src='https://gist.github.com/3688610.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>We <em>want</em> to simply define a named test and make an assertion about our system.  Additionally, we have to pay the Attribute Tax so that NUnit knows which classes contain tests (<code>[TestFixture]</code>), and which methods within those classes are tests (<code>[Test]</code>).  When you take part in the rest of the NUnit fixture lifecycle, you have to litter even more attributes around like <code>[SetUp]</code>, <code>[TearDown]</code>, <code>[TestFixtureSetUp]</code>, and <code>[TestFixtureTearDown]</code>.  Since these lifecycle attributes usually decorate methods with the same name as the attribute, it gets even more pointlessly verbose:</p>
<p><div><script src='https://gist.github.com/3688440.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>xUnit avoids <em>some</em> of this by using different conventions.  Test methods are still marked with an attribute (this time, <code>[Fact]</code> instead of <code>[Test]</code>).  Instead of marking test classes with an attribute, xUnit just infers the obvious: any class with <code>[Fact]</code>s must be a test class.  Instead of setup and teardown methods, xUnit relies on idioms already common in C#: default constructors for setup, and Dispose() for teardown.</p>
<p>I&#8217;ve been using xUnit over NUnit for these reasons (however trivial they are in the context of a large project).  Still, I hate typing ceremony into a project, and it seems like xUnit&#8217;s default conventions got it backwards: why not place an attribute on the test class itself, and then just <em>assume</em> all the public methods in them are tests?</p>
<h2>Minimizing xUnit&#8217;s Ceremony</h2>
<p>One important benefit of xUnit over NUnit is that xUnit is partially customizable.  If you want to define your own alternative to <code>[Fact]</code>, you can.  Also, if you want to use your own convention for discovering which methods in a test class are actually test cases, you can define your own class-level attribute.  This custom attribute goes at the top of the test class and basically means, &#8220;Hold on xUnit, I&#8217;ll take it from here.&#8221;</p>
<p>To implement your own test-method-discovery convention, you must implement ITestClassCommand.  Unfortunately, this interface violates the <a href="http://en.wikipedia.org/wiki/Interface_segregation_principle">Interface Segregation Principle</a>: this interface is large, serving several purposes.  I&#8217;m only interested in providing a new method which says whether or not a given method is a test method.  <strong>Instead of only telling xUnit how to do that, I have to also tell it how to do several other things for which I really just want the default behavior.</strong></p>
<blockquote><p>ISP violations force you to take part in yet more ceremony, supplying boilerplate implementations for details you don&#8217;t wish to customize.</p></blockquote>
<p>To account for this ISP violation, I first created an abstract implementation of ITestClassCommand which uses the default behavior for all these unrelated details, leaving subclasses the responsibility of only having to describe the &#8220;test method discovery&#8221; part.</p>
<p><div><script src='https://gist.github.com/3688482.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Unfortunately, the ISP violation was so significant here that xUnit <em>really, really</em> wanted me to reimplement a fairly involved feature that I never use, <a href="http://xunit.codeplex.com/wikipage?title=Comparisons#note3">IUseFixture&lt;T&gt;</a>.  I decided to give up here, instead implementing the ClassStart method to fail fast: it complains if a developer ever assumes that TestDiscoveryCommands take part in this little-used feature.</p>
<blockquote><p>ISP isn&#8217;t just about being pedantic or fearing all interfaces containing more than one method: in order to write this class properly, I had to read a great deal of xUnit&#8217;s implementation details and <em>still</em> had to gut the IUseFixture&lt;T&gt; feature.</p></blockquote>
<p>Now that TestDiscoveryCommand insulates me from the ISP violation, I can very easily sublcass <em>that</em> to introduce my own test-method-discovery logic:</p>
<p><div><script src='https://gist.github.com/3688532.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>(<em>Aside: <code>void</code> is not a type, but <code>typeof(void)</code> is a <code>Type</code>.  Yikes.</em>)</p>
<p>With these 3 classes in my test assembly, I can convert the old, high-ceremony xUnit style (zero attributes on test classes, one <code>[Fact]</code> per test method) <a href="https://github.com/plioi/rook/compare/d48039983bebd2ee3dbaf09992ad48b438392204...ff8fb1c6896d20db2cd0a2a637a744f2d8827b71">into a slightly-cleaner style</a> (one <code>[Facts]</code> attribute per test class, zero attributes on test methods).</p>
<p>Yes, I was bored.  Very, very bored.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-09-13T00:00:00-05:00" pubdate data-updated="true">Sep 13<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/developer-deep-dive/'>Developer Deep Dive</a>


</div>
	
</div>
</article>

<nav id="pagenavi">
    
        <a href="/blog/page/17/" class="prev">Prev</a>
    
    
        <a href="/blog/page/19/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2013

    Headspring Labs

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>