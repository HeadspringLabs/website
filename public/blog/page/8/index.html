
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Headspring Labs</title>
	<meta name="author" content="Headspring Labs">

	
	<meta name="description" content="Recently, a coworker and I ran into one of those bugs that seem to behave so strangely that you start to wonder, &#8220;Is it me, or is the debugger &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Headspring Labs" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Headspring Labs</a></h1>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/open-source">Open Source</a></li>
	<li><a href="/team">The Team</a></li>
	<li><a href="/about-us">About Us</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:headspringlabs.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/HeadspringLabs" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/HeadspringLabs" title="GitHub">GitHub</a>
		
	    
		
		<a class="coderwall" href="https://coderwall.com/team/headspring" title="Coderwall">Coderwall</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:headspringlabs.com">
	</form>
</nav>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/open-source">Open Source</a></li>
	<li><a href="/team">The Team</a></li>
	<li><a href="/about-us">About Us</a></li>
</ul>
</nav>

</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/the-debugger-must-be-broken/">
		
			The Debugger Must Be Broken!</a>
	</h2>
	<div class="entry-content">
		<p>Recently, a coworker and I ran into one of those bugs that seem to behave so strangely that you start to wonder, &#8220;Is it me, or is the debugger itself buggy?&#8221;  It appeared that the simplest of operations, the assignment operator, was misbehaving.  In the debugger, we seemed to witness a value being properly set to a non-null object and then secretly nulled out as soon as we tried to look at it again.</p>
<p>Of course, whenever a program&#8217;s behavior is so profoundly counter to all that we know to be true, we have to stop, take a deep breath, and proudly exclaim, &#8220;I am making an incorrect assumption!  This code does not say what I think it says.&#8221;</p>
<p>I&#8217;ve boiled the problem down to a simpler form than the original code, and changed names to protect the guilty (me).</p>
<p>We had a collection of DTO instances, of a type we did not have control over (<code>StudentDTO</code>).  In the rest of our system, we wanted to use one of our own classes instead (<code>Student</code>), as <em>our</em> class implemented an interface that was consumed elsewhere (<code>Person</code>):</p>
<p><div><script src='https://gist.github.com/4982706.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>This first pass was bug-free, and the <code>ToPersons</code> method passed our unit test:</p>
<p><div><script src='https://gist.github.com/4982711.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Easy.  C# 101 stuff.  Of course it passed.</p>
<p>Some hours later, I had reason to convert <code>Person</code> from an interface to a concrete class:</p>
<p><div><script src='https://gist.github.com/4982716.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Suddenly, this and many other tests started failing.  <code>persons[0].Name</code> was null!  We set up a breakpoint on the return statement within <code>ToPersons</code>, and saw that each student being returned did in fact get populated correctly.  <strong>Surely, the debugger must be broken!  We clearly populate an object, and when we next look at it it is unpopulated!  Those punks at Microsoft really grind my gears.</strong></p>
<p><strong>Ok, Patrick, take a step back.  What assumption is leading me to believe the debugger is wrong?</strong>  I&#8217;m claiming that a clearly-populated property is null the next time I look at it.  Therefore, I should start to doubt whether I am actually inspecting the same property both times.</p>
<p>In the debugger, we had already seen the <code>Student.Name</code> property set as expected.  We then went to the definition of the Name property that appears in our unit test assertion, which took us to <code>Person.Name</code>.  Here, we also saw a ReSharper warning on each property within <code>Student</code>.  We hadn&#8217;t even <em>changed</em> <code>Student</code>, but that is where the warning appeared: &#8220;The keyword &#8216;new&#8217; is required on &#8216;Name&#8217; because it hides property &#8216;Person.Name&#8217;.&#8221;</p>
<p>Oh, right.</p>
<p>This is one of those details you learn about C# early on and then immediately forget, as it so rarely shows up in practice.  Usually, when a subclass defines members with the same name and signature as its parent class, we are in a abstract/override or virtual/override situation, in which you are knowingly and explicitly stating that the subclass provides its own definition of the parent class&#8217;s behavior.  When a subclass instead defines the same members as its parent <em>without</em> overriding, you get <em>two</em> different implementations at runtime.  It&#8217;s basically just a <em>coincidence</em> that they have the same name.</p>
<p>In this situation, when you look at an instance through a variable declared as the parent type, you see the parent type&#8217;s properties.  When you look at an instance through a variable declared as the subtype, you see the subtype&#8217;s properties.  As we looked at the student variable being returned from the lambda, the debugger showed us the populated <code>Student.Name</code>, and when our test assertion looked at the person returned from the lambda, the test experienced the unpopulated <code>Parent.Name</code>.</p>
<p>When up is down, black is white, and the debugger stops working, put the apparently impossible behavior into plain English, and cast some healthy doubt on each word.  You&#8217;ve got a faulty assumption in there somewhere.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-02-19T00:00:00-06:00" pubdate data-updated="true">Feb 19<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/developer-deep-dive/'>Developer Deep Dive</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/wcf-ioc-away-the-need-for-named-pipes/">
		
			WCF IOC Away the Need for Named Pipes</a>
	</h2>
	<div class="entry-content">
		<p>The NetNamedPipeBinding is the optimized binding for on-machine communication.  For most WCF implementations I have seen WCF is really only there to help facilitate RPC (Remote Procedure Calls).  When WCF is simply a way to segment your service layer into an optionally distributed deployment architecture there may be a much better way.  WCF has additional overhead that seams useless if the code is being executed on the same machine.  IOC (Inversion of Control) using DI (Dependency Injection) provides a relatively simple way to avoid WCF all together.</p>
<p>Lets take a simple WCF Service Contract for Customers.<br />
<div><script src='https://gist.github.com/4945825.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>The client creates a proxy and through WCF configuration the proper binding can be used to communicate with the Service.  In order to make the client know where the service is without hardcoding this you would have the following configuration settings.</p>
<pre class="csharpcode">  &lt;span class=&quot;kwrd&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;html&quot;&gt;system.serviceModel&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;kwrd&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;html&quot;&gt;bindings&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;kwrd&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;html&quot;&gt;basicHttpBinding&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;kwrd&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;html&quot;&gt;binding&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;=&quot;BasicHttpBinding_ICustomerService&quot;&lt;/span&gt; &lt;span class=&quot;kwrd&quot;&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;kwrd&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;html&quot;&gt;basicHttpBinding&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;kwrd&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;html&quot;&gt;bindings&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;kwrd&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;html&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;kwrd&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;html&quot;&gt;endpoint&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;address&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;=&quot;http://localhost:26859/CustomerService.svc&quot;&lt;/span&gt;
        &lt;span class=&quot;attr&quot;&gt;binding&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;=&quot;basicHttpBinding&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;bindingConfiguration&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;=&quot;BasicHttpBinding_ICustomerService&quot;&lt;/span&gt;
        &lt;span class=&quot;attr&quot;&gt;contract&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;=&quot;OptionalWCF.Contracts.ICustomerService&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;=&quot;BasicHttpBinding_IUserProfileService&quot;&lt;/span&gt; &lt;span class=&quot;kwrd&quot;&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;kwrd&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;html&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;kwrd&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;html&quot;&gt;system.serviceModel&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;&amp;gt;&lt;/span&gt;</pre>
<p>Most clients stop there rather than have a explicit setting for NetNamedPipes.  If they decided to “Optimize” they could add the WCF configuration endpoint for NetNamedPipes and modify the Service to expose a NetNamedPipe endpoint.  Now the client can use the NetNamedPipe endpoint and the performance has been improved.  In reality the performance between NetTcp and NetNamedPipe is rather minimal with a slighter advantage over BasicHttp.  The most optimal invocation is in-process so why not just go around WCF all together.  We already have the interface separation that DI can use and either way if we want optimal performance we will be tweaking configuration files for different deployment environments.</p>
<p>For this blog I choose StructureMap as my DI library.  My client Code only needs to get a handle to the interface.</p>
<div class="csharpcode">
<pre class="alt">var customerServices = ObjectFactory.GetInstance&amp;lt;ICustomerService&amp;gt;();</pre>
</div>
<p>The client is configured to either use WCF or use the direct reference to the service implementation of the service Contract.</p>
<pre class="csharpcode">&lt;span class=&quot;kwrd&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;html&quot;&gt;StructureMap&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;MementoStyle&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;=&quot;Attribute&quot;&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;rem&quot;&gt;&amp;lt;!-- WCF Service Through Proxy --&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;kwrd&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;html&quot;&gt;DefaultInstance&lt;/span&gt;
      &lt;span class=&quot;attr&quot;&gt;PluginType&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;=&quot;OptionalWCF.Contracts.ICustomerService, OptionalWCF&quot;&lt;/span&gt;
      &lt;span class=&quot;attr&quot;&gt;PluggedType&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;=&quot;OptionalWCF.Client.CustomerServiceProxyWrapper, OptionalWCF.Client&quot;&lt;/span&gt;
      &lt;span class=&quot;attr&quot;&gt;Scope&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;=&quot;Singleton&quot;&lt;/span&gt;
      &lt;span class=&quot;kwrd&quot;&gt;/&amp;gt;&lt;/span&gt;

    &lt;span class=&quot;rem&quot;&gt;&amp;lt;!--Real Service--&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;rem&quot;&gt;&amp;lt;!--&amp;lt;DefaultInstance&lt;/span&gt;
&lt;span class=&quot;rem&quot;&gt;      PluginType=&quot;OptionalWCF.Contracts.ICustomerService, OptionalWCF&quot;&lt;/span&gt;
&lt;span class=&quot;rem&quot;&gt;      PluggedType=&quot;OptionalWCF.ServiceImpl.CustomerService, OptionalWCF.ServiceImpl&quot;&lt;/span&gt;
&lt;span class=&quot;rem&quot;&gt;      Scope=&quot;Singleton&quot;&lt;/span&gt;
&lt;span class=&quot;rem&quot;&gt;      /&amp;gt;--&amp;gt;&lt;/span&gt;
&lt;span class=&quot;kwrd&quot;&gt;&amp;lt;/&lt;/span&gt;&lt;span class=&quot;html&quot;&gt;StructureMap&lt;/span&gt;&lt;span class=&quot;kwrd&quot;&gt;&amp;gt;&lt;/span&gt;</pre>
<p>Now if the client is running on the same machine WCF is discarded.  If the service is moved to another machine with a simple configuration file tweak WCF is used.  The clients code is none the wiser.</p>
<p>This pattern can be extending to support duplex communication by using .Net events instead of exposing the callback contracts to the clients.  I plan on writing an additional blog to cover this topic.</p>
<p>The full source to this post can be downloaded here <a href="http://www.headspring.com/wp-content/uploads/2013/02/OptionalWCF.zip">OptionalWCF</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-02-13T00:00:00-06:00" pubdate data-updated="true">Feb 13<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/blog/'>Blog</a>, <a class='category' href='/blog/categories/developer-deep-dive/'>Developer Deep Dive</a>, <a class='category' href='/blog/categories/named-pipes/'>Named Pipes</a>, <a class='category' href='/blog/categories/wcf/'>WCF</a>, <a class='category' href='/blog/categories/dependency-injection/'>dependency injection</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/from-imperative-to-declarative/">
		
			From Imperative to Declarative</a>
	</h2>
	<div class="entry-content">
		<p>Two weeks ago, we took a peek at the <a href="http://www.headspring.com/patrick/whittling-parsley/">low-level pattern recognition classes</a> that make up the core of <a href="https://github.com/plioi/parsley">Parsley</a>.  Last week, we saw how pattern recognition involves 3 pivotal <a href="http://www.headspring.com/patrick/composable-operations/">composable operations</a>: repetition, choice, and sequence.  We saw how Parsley implements basic repetition and choice operations, but sequence was still too hard to address.</p>
<p>Today, we&#8217;ll finally see how to extract a useful sequence operation into a useful class, finally giving us the last of the necessary composable operations, and freeing us to finish our high-level <a href="http://martinfowler.com/bliki/DomainSpecificLanguage.html">DSL</a>.</p>
<h2>Manual Sequence Recognition</h2>
<p>Recall the horrible imperative code necessary to recognize the trivial three-token sequence of [left-parenthesis, letter, right-parenthesis]:</p>
<p><div><script src='https://gist.github.com/4688927.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>To recognize a 3 token sequence, we need 3 nested if statements and 4 return statements.  To recognize an N token sequence, we need N nested if statements and N+1 returns.  Each if statement tests whether the last call to Parse(&#8230;) succeeded, and each if statement&#8217;s body hands off the remanining unparsed tokens to the next step.  Clearly, this does not scale well.</p>
<h2>(Ab)using LINQ</h2>
<p>Note how similar each step is: we always call Parse(&#8230;), then test for success, then pass the remaining unparsed tokens along.  The main thing that changes each time we dig deeper is the particular Parser object in play.  I&#8217;d rather just say &#8220;Require(LeftParen), then Require(Letter), then Require(RightParen), halting at the first point of failure&#8221;.</p>
<p>Our goal is to extract the &#8220;success check and unparsed token hand-off&#8221; action so that we don&#8217;t have to repeat it ourselves, and we want to do so in a way that lets us chain together any number of parsers representing a sequence of expectations, without having to indent deeper as the chain grows longer.  With no further ado, ParserQuery:</p>
<p><div><script src='https://gist.github.com/4802811.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p><strong>I apologize for this.</strong>  This was hands-down the most difficult 12 lines of code I have written or will ever write.  The pattern in play here is so difficult, so abstract, that <em>I don&#8217;t even know what to name some of the variables.</em></p>
<p>This is the <a href="http://blogs.msdn.com/b/wesdyer/archive/2008/01/11/the-marvels-of-monads.aspx">Monad</a> pattern.  It can be performed in any language that has lambda expressions in which the lambda body can refer to variables in the surrounding scope, like C#, Javascript, and Python, but is only ever used in practice when the language <em>also</em> has special syntax for its usages.  In C#, the special syntax which makes this pattern compelling is the <code>from/select</code> LINQ syntax.</p>
<p>This special syntax lets us &#8220;flatten&#8221; our nested if statements into a series of &#8216;from&#8217; clauses.  When using the complete Parsley DSL, we can rewrite IsParenthesizedLetter without any nesting:</p>
<p><div><script src='https://gist.github.com/4919965.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>ParserQuery defines some extension methods that are treated specially by the compiler.  Their existence allows us to select from Parser&lt;T&gt; objects instead of the usual ability to select from IEnumerable&lt;T&gt; objects.  Note how instead of having 3 nested if statements, we have 3 from clauses <em>in sequence</em>.</p>
<p>Note how the query does little more than <em>list</em> the 3 expectations in the order we expect them to appear in the input.  We &#8220;flattened&#8221; the nested if statements into a vertical series of from clauses.</p>
<p>Note also how this sequence operation is operating on 3 Parser&lt;Token&gt; objects (the right hand side of each from clause) and the type of the whole query is <em>also</em> a Parser&lt;Token&gt;.  Since our sequence operation results in the same type as it acts on, it is highly composable with last week&#8217;s repetition and choice operations.</p>
<p>Although complicated, there&#8217;s no magic here.  If we ask ReSharper to translate the above select statement into plain old method calls, we see that ParserQuery&#8217;s SelectMany method is being called N-1 times when there are N from clauses:</p>
<p><div><script src='https://gist.github.com/4942002.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>In other words, our SelectMany method&#8217;s job is to hook a single from clause into the chain of execution.</p>
<p>C# rewrites a flat query into calls to the SelectMany extension method, which in turn does the success check and the passing along of remaining unparsed tokens, so all the same <em>work</em> is going on here as in the origial imperative code.  Thankfully, we&#8217;re no longer the ones doing that work!</p>
<p>Rather than trying to make sense of ParserQuery itself, it may be more illuminating to read <a href="https://github.com/plioi/parsley/blob/cb69098da8135f7ac5fb1b0f84071e0e8b94b8a0/src/Parsley.Test/ParserQueryTests.cs">ParserQuery&#8217;s unit tests</a>.</p>
<h2>So Where Are We?</h2>
<p>2 weeks back, we started with the low-level imperative classes.  These let us deliberately walk through the input, pattern matching as we go along.  It was annoying, but it worked.  Like assembly language, we wanted to instead work with a high-level alternative, even if the high-level alternative was ultimately doing this imperative stuff behind the scenes.</p>
<p>1 week back, we identified 3 fundamental operations necessary for a pattern recognition DSL: repetition, choice, and sequence.  We saw how repetition could be implemented as a class, ZeroOrMoreParser.  We saw how choice could be implemented as a class, ChoiceParser.</p>
<p>This week, we see that sequence can be handled by ParserQuery and the from/select keywords.</p>
<p><strong>Now, we have all the tools we need to finally create our DSL.</strong></p>
<h2>Assembling Parsley&#8217;s DSL</h2>
<p>Parsley deals with defining grammars for languages.  You could define a grammar for a language like JSON, and use that to turn JSON text into .NET objects.  Parsley contains a Grammar class full of useful operations.  To keep things highly-composable, many of these operations both produce Parser&lt;T&gt; objects and operate on other Parser&lt;T&gt; objects.</p>
<p>First, the Grammar class includes a few helper methods for constructing the classes developed last week:</p>
<p><div><script src='https://gist.github.com/4911336.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Next, we note that ZeroOrMore is useful, but not really enough in practice.  We may rather require that the input include OneOrMore occurrences of something.  Thankfully, we can <em>compose</em> sequence with ZeroOrMore to build OneOrMore.  OneOrMore things is the same as one thing followed by ZeroOrMore things:</p>
<p><div><script src='https://gist.github.com/4912909.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Where ZeroOrMore required a whole class full of imperative code, OneOrMore required <em>one 3-line expression</em>.</p>
<p>It&#8217;s also very common to expect the input to contain a repetition of items <em>separated by</em> some other expected thing.  A JSON array literal contains zero or more items <em>separated by</em> commas.  Here, the third operation, choice, makes an appearance.</p>
<p><div><script src='https://gist.github.com/4914803.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Finally, a little payoff for all this infrastructure!  Imagine how horrifyingly verbose and error-prone these methods would be, if we had to implement them directly in terms of the low-level imperative style.</p>
<p>Lastly, there&#8217;s one more built-in operation worth discussing as it directly affects the IsParenthesizedLetter method from the start of this post.  We often need to recognize that something important appears <em>between</em> two other, less important things.  A JSON array is zero or more items <em>between</em> the &#8220;[&#8221; and &#8220;]&#8221; symbols.  We care that the &#8220;[&#8221; and &#8220;]&#8221; are present, but the meaningful data we want to extract from that is the part in the middle:</p>
<p><div><script src='https://gist.github.com/4916812.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<h2>Revisiting the Original Example</h2>
<p>Now, in order to recognize a parenthesized letter, all we need is:</p>
<p><div><script src='https://gist.github.com/4923462.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>Here, parenthesizedLetter is an object which can be handed the raw input tokens and can reply with one of two statements: &#8220;The input is not a parenthesized letter and here is why,&#8221; or &#8220;The input is a parenthesized letter and here is that letter.&#8221;  No nested if statements, no explicit progress through the token stream, no manual error checks at every step.</p>
<p>Most importantly, this says <em>what</em> it does rather than <em>how</em>.  <strong>We&#8217;ve turned our imperative API into a declarative API by repeatedly extracting common and monotonous patterns into highly-composable operations, and by further hiding those helper classes behind a few simply-named helper methods.</strong></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-02-13T00:00:00-06:00" pubdate data-updated="true">Feb 13<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/developer-deep-dive/'>Developer Deep Dive</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/composable-operations/">
		
			Composable Operations</a>
	</h2>
	<div class="entry-content">
		<p>Last week, we took a peek at the <a href="http://www.headspring.com/patrick/whittling-parsley/">low-level pattern recognition classes</a> that make up the core of Parsley.  The final example showed how you can walk through some untrustworthy text in small and deliberate steps, looking for expected input along the way.  At each step, the step either succeeds or fails.  On success, the remaining unparsed text is passed along to the next step.</p>
<p>This process was the epitome of imperative coding: <em>Do this, and then do this, and then do that.</em>  Despite this imperative core, I&#8217;d describe the intended usage of Parsley as declarative: <em>Here&#8217;s what valid input looks like, figure out the details for me.</em></p>
<p>I said I&#8217;d reveal this week how this shift from low-level imperative coding to high-level declarative coding can be implemented, but I&#8217;ve decided to split it into two posts.  This week, we&#8217;ll see how Parsley builds on the frustrating foundation by baking in a few fundamental and composable imperative operations.  Next week, we&#8217;ll see how that more-useful layer can be extended into a high-level <a href="http://martinfowler.com/bliki/DomainSpecificLanguage.html">Domain Specific Language</a> (DSL).</p>
<p><strong>A declarative API needs to give your end users a suite of useful and familiar words, in such a way that the words can be easily combined to form larger declarations.</strong>  We&#8217;re going to take some important imperative operations, give them useful names, and package them up in such a way that they will compose well with each other.</p>
<h2>Pattern Recognition Fundamentals</h2>
<p>Parsley can recognize patterns not unlike those recognized by regexes.  When working with regexes, we&#8217;re constantly composing three fundamental operations: repetition, choice, and sequence.</p>
<p>With <strong>repetition</strong>, we say, &#8220;I&#8217;ve got this regex here, and I want it to be repeated.&#8221;  The regex &#8220;A&#8221; recognizes a single letter &#8220;A&#8221;, and we can produce a more interesting regex &#8220;A*&#8221; to recognize zero-or-more As, or &#8220;A+&#8221; to recognize one-or-more As.  A more complex pattern like &#8220;(A+B+)&#8221; can likewise be made more interesting via repetition: &#8220;(A+B+)*&#8221; which recognizes zero-or-more occurrences of As-followed-by-Bs.</p>
<p>With <strong>choice</strong>, we can combine some small patterns into a larger one by saying, &#8220;Any one of these subpatterns could happen next.&#8221;  The regex &#8220;A|B&#8221; recognizes either an &#8220;A&#8221; or a &#8220;B&#8221;.</p>
<p>With <strong>sequence</strong>, we can combine some small patterns into a larger one by saying, &#8220;The first pattern, followed by the second, followed by the third.&#8221;  Regexes achieve this by just squishing them together in order: the regex &#8220;ABC&#8221; recognizes an A, followed by a B, followed by a C.  They all have to appear, and in that order.</p>
<p>These three operations <em>compose</em> very well.  The regex @&#8221;[_a-zA-Z]+[_a-zA-Z0-9]*&#8221; recognizes variable names.  We have repetition: the pattern has one-or-more leading characters and zero-or-more trailing characters.  We have choice: each character is an underscore or a letter or a digit.  We have sequence: to enforce that names don&#8217;t start with a digit, we have a two-part sequence of leading characters <em>followed by</em> trailing characters.  We say these operations &#8220;compose well&#8221; because:</p>
<ol>
<li>They can be applied to any pattern.</li>
<li>Doing so takes very little code.</li>
<li>Most importantly, <strong>the result is also a pattern to which the operations can be applied again.</strong></li>
</ol>
<p>If our API can exhibit these three properties, we can say it is &#8220;highly composable&#8221;, which should go a long way to making the API declarative as well.  Instead of telling the machine what to do, step by step, we&#8217;ll just glue together a bunch of small words into a larger statement.  The small words and the glue operations we perform on them will hide all the imperative details.</p>
<h2>What Hurt Last Week</h2>
<p>The big example at the end of the <a href="http://www.headspring.com/patrick/whittling-parsley/">last post</a> just had to tell the user whether or not a string was a single letter surrounded by parentheses.  Despite being a simple pattern, the code involved was quite large and annoying to write.</p>
<p>Recall the Parser&lt;T&gt; interface:</p>
<p><div><script src='https://gist.github.com/4727988.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>A Parser of Things consumes some input tokens with the intent to construct a Thing.  On success, the Parser of Things produces a Thing and a reference to the remaining unconsumed tokens.  On failure, you get an error instead of a Thing.</p>
<p>To write the Parser of Parenthesized Letters, we first needed to write an implementation of this interface, just so that we could say &#8220;I expect the next token to be of a certain kind, would you kindly try to consume one such token?&#8221;  We then made a convenience method to construct instances of this class, to save on keystrokes later.  Finally, we could write the big, ugly Parser of Parenthesized Letters.</p>
<p>It hurts to have to write so much for so little gain.  I&#8217;d rather Parsley contain a suite of useful Parser&lt;T&gt; implementations out of the box, so I could just dive in and focus on detecting the pattern I&#8217;m interested in.  This suite of useful Parser&lt;T&gt; implementations ought to include our 3 fundamental/composable pattern-recognition operations: repetition, choice, and sequence.</p>
<p>First, though, the suite should provide some primitive operations to get started with.  Compared to our regex examples, we need to be able to express things like &#8220;A&#8221; before we can augment them into interesting patterns like &#8220;A*&#8221;.</p>
<h2>Parsley&#8217;s Default Parsers</h2>
<p>The default parser implementations are as frustrating to write as the sample from last week, since they are written in terms of the awkward low-level API.  However, they make things easier on the end user, as we&#8217;ll see next week.  They are found under the <a href="https://github.com/plioi/parsley/tree/cb69098da8135f7ac5fb1b0f84071e0e8b94b8a0/src/Parsley/Primitives">Primitives</a> folder.  Four of these are relevant to today&#8217;s discussion:</p>
<p><strong>TokenByKindParser</strong> - Last week we wrote a parser that takes an expected token <em>kind</em> and demands that the next token in the input be of that kind.  On success, the token is consumed.  For instance, if you are parsing C# you may reach a point where you expect the next token to be an identifier.  You don&#8217;t care what specific identifier it is, only that it is an identifier as opposed to an operator or number.  The real implementation of that class in Parsley is called TokenByKindParser:</p>
<p><div><script src='https://gist.github.com/4728010.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p><strong>TokenByLiteralParser</strong> - Sometimes you have a more specific expectation of what will appear next in the input.  Rather than only caring about what kind of token appears next, you&#8217;ll expect that the token will be a specific known string.  When parsing C#, you may reach a point where you know the next token must be a &#8220;;&#8221; character.  TokenByLiteralParser serves this purpose.  As with TokenByKindParser, we simply inspect the current token and return success or failure, advancing one token on success:</p>
<p><div><script src='https://gist.github.com/4728017.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p><strong>ZeroOrMoreParser</strong> - This class gives us our much-needed repetition operation.  Note that this class is constructed <em>with another Parser&lt;T&gt;</em> to be augmented, just as the regex &#8220;A&#8221; augmented by &#8220;*&#8221; becomes the regex &#8220;A*&#8221;.  The parser works by attempting the given parser against the input.  On success, we repeat from the new position in the input, collecting each intermediate result into a list.  As soon as the item-parser finally fails, we are finished and can return a successful result containing all the items collected along the way.  Note that this is a Parser&lt;IEnumerable&lt;T&gt;&gt;, meaning that after consuming a bunch of tokens, the result you get is a collection of things, where each thing was recognized by the initial input Parser&lt;T&gt;.  That&#8217;s our first hint at composabilty:</p>
<p><div><script src='https://gist.github.com/4728052.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p><strong>ChoiceParser</strong> - This beast gives us our much-needed choice operation.  When we want the next thing in the input to be one of several possible things, and each of those things is individually recognized by a different Parser class, this combines them into one operation that says &#8220;Any of these things could appear next.&#8221;  The first one to match the input wins:</p>
<p><div><script src='https://gist.github.com/4728061.js'></script>
<noscript><pre><code></code></pre></noscript></div>
</p>
<p>ZeroOrMoreParser and ChoiceParser make up a part of the composability we are shooting for here.  They take in Parsers as their input and are themselves Parsers.  That means you could feed one into the other: you might have two ZeroOrMoreParser instances, and pass them into a ChoiceParser: I expect zero-or-more As or else I expect zero-or-more Bs.</p>
<p>There&#8217;s a subtle gotcha within both ZeroOrMoreParser and ChoiceParser.  By default, Parsley distinguishes between a parser that fails <strong>without</strong> advancing in the input and a parser that fails <strong>after</strong> advancing in the input.  If you are parsing C# and you know that the next thing in the input is a choice between a foreach statement or an if statement, but the input is &#8220;if $typo$&#8221;, we don&#8217;t just want to say that the choice failed; we want to say that your if statement is broken.  This is why these two classes care so much about detecting changes in position along the way.</p>
<h2>What About Sequence?</h2>
<p>TokenByKindParser and TokenByLiteralParser give us our trivial starting point, like a regex that only recognizes a single letter &#8220;A&#8221;.  ZeroOrMoreParser gives us repetition.  ChoiceParser gives us choice.  We still don&#8217;t have a useful sequence operation to build on.  Our complicated example from last week is still complicated!</p>
<p>Recall my criticism from last week:</p>
<blockquote><p>[IsParenthesizedLetter] is nearly as tedious as writing assembly. Each time I wanted to progress a little further, I had to indent again and declare some new local variables. I had to carefully pass along the remaining unparsed tokens at each step, and I had to concern myself with failure at each step.</p>
<p>To make matters worse, this stuff motivates having lots of returns from a single function, making it extremely hard to break the function apart into smaller parts. <a href="http://www.headspring.com/patrick/detect-reflect-decomplect/">Return statements are &#8220;Extract Method&#8221; fences.</a></p></blockquote>
<p>With all the code we&#8217;ve seen so far, we&#8217;re stuck with implementing all sequence patterns in this way, producing a convoluted morass of nested if statements.  We don&#8217;t even have the option of Extract Method refactorings to ease the pain.  We&#8217;ve coded ourselves into a corner!</p>
<p>Fortunately, a little-used design pattern will save the day next week, allowing us to bottle up the subtle code duplication exhibited by last week&#8217;s manual attempt at a sequence operation.  Once we have sequencing down, all of these peices will start to fit together smoothly, and our end user will finally have that suite of useful composable words at their disposal.</p>
<h2>Recap</h2>
<p>Last week, we saw how Parsley represents progress through the input, and caught a glimpse of how a desired pattern can be recognized (or not) within that input.  The code to use those classes was verbose, ugly, and apparently refactor-proof.</p>
<p>To ease the pain, we&#8217;ve seen how a few composable operations could be provided on top of the original core classes, but we&#8217;re still left with the tricky situation of sequencing.  Next week, we&#8217;ll implement sequencing, completing our DSL and insulating the end user from having to work with the ugly core directly.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-02-07T00:00:00-06:00" pubdate data-updated="true">Feb 7<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/developer-deep-dive/'>Developer Deep Dive</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/mvc-boot-camp/">
		
			MVC Boot Camp</a>
	</h2>
	<div class="entry-content">
		<p><img class="size-full wp-image-5716 alignright" title="ASP.NET MVC4 In Action" alt="ASP.NET MVC4 In Action" src="http://www.headspring.com/wp-content/uploads/2012/06/Palermo-ASPNET4-fc.jpg" width="239" height="300" /></p>
<p>&nbsp;</p>
<p>Instead of listening to lectures and doing boring written exercises, participants jump in and work on real code using real examples - applying these techniques on an existing application.</p>
<p>We&#8217;ve made registration even easier through Eventbrite, but for other registration options call (877) 459 - 2260</p>
<p><strong>Next Class: TBD - Ask about private training options</strong></p>
<p><strong>You’ll Come Out of MVC Boot Camp Knowing:</strong></p>
<ul>
<li>How to Avoid Common Web Development Pitfalls</li>
<li>How to Write Maintainable Systems</li>
<li>25% Discount on a Personal ReSharper License</li>
</ul>
<p>Best of all, we have updated our curriculum for the latest version of MVC4 and mobile web development. If you are looking to get started with MVC, convert from an older version or learn how to use MVC in mobile web development projects, we highly recommend this course.</p>
<p><em> <a title="MVC4 Boot Camp Curriculum" href="http://www.headspring.com/headspring/mvc-boot-camp/" target="_blank">Course curriculum</a> was created by the guys that wrote the book on <strong>MVC</strong>, Jeffrey Palermo and Jimmy Bogard.</em></p>
<p><strong>Who Benefits Most? Developers With:</strong></p>
<ul>
<li>1 Year+ Experience in C#</li>
<li>A Basic Understanding of Web Development Languages, Including HTML</li>
<li>A Basic Understanding of the Web Life-Cycle</li>
</ul>
<p><em></em>Cost $1,975</p>
<p>If you have any concerns whether or not this course is a fit, contact us for help at (512) 459 – 2260..</p>
<p>Training located in Austin, Texas (8:30 a.m. to 5:00 p.m.)</p>
<p>View a <a title="Contact" href="http://www.headspring.com/contact/">map to our facility</a> and nearby hotels.</p>
<p>Although it is unlikely, class dates are subject to change. We encourage you to obtain transferable airline/hotel reservations in the event that this should occur.</p>
<p>By signing up for a Headspring training course, you are accepting the terms and conditions of our <a title="Education Services Agreement" href="http://www.headspring.com/education-services-agreement/" target="_blank">Education Services Agreement</a>.</p>
<p>&nbsp;</p>
<p><strong>Agenda</strong></p>
<p><strong>Day 1</strong></p>
<p><strong>Session 1.1 – MVC Overview</strong><br />
<em>Background<br />
MVC parts</em></p>
<p><strong>Session 1.2 – Controller basics</strong><br />
<em>Anatomy of an Action<br />
Querystring parameters<br />
Working with forms<br />
Model binding<br />
View data</em></p>
<p><strong>Session 1.3 – View basics</strong><br />
<em>WebForms view engine<br />
Razor view engine<br />
Folder structure<br />
Execution order<br />
View data<br />
Helpers<br />
URLs</em></p>
<p><strong>Session 1.4 – Model basics</strong><br />
<em>Persistence/Domain Model vs. View Model<br />
Projection<br />
Repositories</em></p>
<p>&nbsp;</p>
<p><strong>Day 2</strong></p>
<p><strong>Session 2.1 – Routing</strong><br />
<em>Routing in the MVC pipeline<br />
Designing URLs<br />
SEO<br />
Custom routes</em></p>
<p><strong>Session 2.2 – Controller in depth</strong><br />
<em>ActionResults<br />
ActionFilters<br />
Customizing the controller</em></p>
<p><strong>Session 2.3 – Model in depth</strong><br />
<em>ViewModels<br />
AutoMapper<br />
Custom ModelBinders</em></p>
<p><strong>Session 2.4 – View in depth</strong><br />
<em>Layouts and Master Pages<br />
Partials<br />
Child actions</em></p>
<p>&nbsp;</p>
<p><strong>Day 3</strong></p>
<p><strong>Session 3.1 – Templates and validation</strong><br />
<em>View/Edit templates<br />
Validation<br />
Custom validators</em></p>
<p><strong>Session 3.2 – AJAX and jQuery</strong><br />
<em>Intro to jQuery<br />
Integrating jQuery<br />
AJAX and MVC</em></p>
<p><strong>Session 3.3 – Testing ASP.NET MVC</strong><br />
<em>Unit testing MVC pieces<br />
UI testing</em></p>
<p><strong>Session 3.4 – Best Practices in ASP.NET MVC</strong><br />
<em>Lessons learned from large ASP.NET MVC projects</em></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-02-05T00:00:00-06:00" pubdate data-updated="true">Feb 5<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/events/'>Events</a>


</div>
	
</div>
</article>

<nav id="pagenavi">
    
        <a href="/blog/page/7/" class="prev">Prev</a>
    
    
        <a href="/blog/page/9/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2013

    Headspring Labs

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>